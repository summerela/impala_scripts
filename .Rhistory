packrat::set_opts(external.packages = c(""))
library(RODBC)
install.packages("RODBC")
library(RODBC)
install.packages("RODBC",type = "source")
install.packages("RODBC",type = "source")
install.packages("RODBC",type = "source")
library(RODBC)
conn <- odbcConnect("Cloudera Impala DSN")
conn <- odbcConnect("Impala DSN")
conn <- odbcConnect("Impala DSN")
conn <- odbcConnect("Impala DSN")
conn <- odbcConnect("Impala DSN")
conn <- odbcConnect("Impala DSN")
conn <- odbcConnect("Impala DSN")
conn <- odbcConnect("Impala DSN")
conn <- odbcConnect("Impala DSN")
conn
df <- data.frame( name=c("John", "Adam"), date=c(3, 5) )
df
df[df$date>4 & df$date<6, ]
df <- data.frame( name=c("John", "Adam", "steve"), date=c(3, 5, 7) )
df[df$date>4 & df$date<6, ]
df[df$date<5 & df$date>6, ]
ensembl = sqlFetch(conn, "p7dev.sum_test")
library(RODBC)
conn <- odbcConnect("Impala DSN")
ensembl = sqlFetch(conn, "p7dev.sum_test")
head(ensembl)
dim(ensembl)
dim(ensembl[which(ensembl$vcf_chrom != ensembl$ens_chrom)])
vcf = sqlFetch(conn, "p7dev.sum_test")
head(vcf)
dim(vcf)
ensembl = sqlFetch(conn, "public_hg19.ensembl"")
ensembl = sqlFetch(conn, "public_hg19.ensembl")
ensembl = sqlFetch(conn, "public_hg19.ensembl")
ensembl = sqlFetch(conn, "public_hg19.ensembl_genes")
head(ensembl)
dim(ensembl)
chr_match = merge(vcf, ensembl, by=chromosome)
chr_match = merge(vcf, ensembl, by='chromosome')
library(data.table)
vcf_table = data.table(vcf)
ens_table  data.table(ens)
ens_table = data.table(ens)
ens_table = data.table(ensembl)
chr_match = merge(vcf_table, ens_table, by='chromosome')
head(vcf_table$chromosome)
head(ens_table$chromosome)
head(ens_table)
head(ensembl)
ens_results = read.csv("./queries/testing/query_result_ensembl.csv")
suppressMessages(library(RODBC))
conn <- odbcConnect("Impala DSN")
vcf = sqlFetch(conn, "p7dev.illumina_test")
head(vcf)
dim(vcf)
ens = sqlFetch(conn, "p7dev.ensembl_test")
head(ens)
dim(ens)
setwd("~/impala_scripts/queries/testing")
ens_results = read.csv("./query_result_ensembl.csv")
suppressMessages(library(GenomicRanges))
suppressMessages(library(IRanges))
##subset for only vcf rows that passed filtering
vcf_pass = vcf[which(vcf$filter == "PASS"),]
#create GRanges objects for comparison
vars = with(vcf_pass, GRanges(seqnames=vcf_pass$chromosome,
ranges=IRanges(vcf_pass$pos, width=1,
names=paste(vcf_pass$sample_id, ":",vcf_pass$ref, ">", vcf_pass$alt, sep="")),rsID=vcf_pass$id, filter=vcf_pass$filter, qual=vcf_pass$qual, sample_id=vcf_pass$sample_id))
genes = with(ens, GRanges(seqnames=ens$chromosome,
ranges=IRanges(ens$start, ens$stop,names=ens$gene_id),
feature=ens$feature, trans_id=ens$transcript_id, gene_id=ens$gene_id, gene_name=ens$gene_name, trans_name=ens$transcript_name, exon=ens$exon_id))
##find variants that fall in gene regions
match = suppressWarnings(findOverlaps(vars, genes))
head(match)
match.df = data.frame(sample_id = as.character(mcols(vars)$sample_id)[queryHits(match)],
chrom = seqnames(vars)[queryHits(match)],
pos = as.data.frame(ranges(vars))$start[queryHits(match)],
variant = as.character(lapply(strsplit(as.character(names(vars)[queryHits(match)]), ":"), function(x) x[2])),
rsId = as.character(mcols(vars)$rsID)[queryHits(match)],
gene_name = mcols(genes)$gene_name[subjectHits(match)],
gene_id = names(genes)[subjectHits(match)],
trans_name = mcols(genes)$trans_name[subjectHits(match)],
trans_id = mcols(genes)$trans_id[subjectHits(match)],
exon_id = mcols(genes)$exon[subjectHits(match)],
feature = mcols(genes)$feature[subjectHits(match)],
stringsAsFactors=F)
head(match.df)
dim(match.df)
ens_results$variant = paste(ens_results$vcf_ref, ">", ens_results$vcf_alt, sep="")
ens.df = ens_results[c(1,2,3,17,6,10,11,13,14,15,9)]
colnames(ens.df) = colnames(match.df)
head(ens.df)
ens.df = ens.df[with(ens.df, order(sample_id, chrom, pos, variant, gene_name, gene_id, trans_name, trans_id, exon_id, feature)),]
match.df = match.df[with(match.df, order(sample_id, chrom, pos, variant, gene_name, trans_name, trans_id, exon_id, feature)),]
i = sapply(ens.df, is.factor)
ens.df[i] = lapply(ens.df[i], as.character)
j = sapply(match.df, is.factor)
match.df[j] = lapply(match.df[i], as.character)
match.df[j] = lapply(match.df[j], as.character)
rownames(match.df)= NULL
rownames(ens.df) = NULL
ens.df$rsId = gsub("NULL", "NA", ens.df$rsId)
which(match.df != ens.df, arr.ind=TRUE)
match.df[,351]
match.df[351,]
ens.df[351,]
match.df = data.frame(sample_id = as.character(mcols(vars)$sample_id)[queryHits(match)],
chrom = seqnames(vars)[queryHits(match)],
pos = as.data.frame(ranges(vars))$start[queryHits(match)],
variant = as.character(lapply(strsplit(as.character(names(vars)[queryHits(match)]), ":"), function(x) x[2])),
rsId = as.character(mcols(vars)$rsID)[queryHits(match)],
gene_name = mcols(genes)$gene_name[subjectHits(match)],
gene_id = names(genes)[subjectHits(match)],
trans_name = mcols(genes)$trans_name[subjectHits(match)],
trans_id = mcols(genes)$trans_id[subjectHits(match)],
exon_id = mcols(genes)$exon[subjectHits(match)],
feature = mcols(genes)$feature[subjectHits(match)],
stringsAsFactors=F)
#450 rows, same as impala query
head(match.df)
dim(match.df)
match.df = match.df[with(match.df, order(sample_id, chrom, pos, variant, gene_name, trans_name, trans_id, exon_id, feature)),]
head(match.df)
j = sapply(match.df, is.factor)
match.df[j] = lapply(match.df[j], as.character)
head(match.df)
match.df[351,]
rownames(match.df)= NULL
rownames(ens.df) = NULL
match.df[351,]
ens.df$rsId = gsub("NULL", "NA", ens.df$rsId)
which(match.df != ens.df, arr.ind=TRUE)
which(rand_match != match_imp_results, arr.ind=TRUE)
rand_match
rand_match = match.df[(match.df$gene_name %in% rand_genes),]
rand_genes = sample(unique(match.df$gene_name), 5)
rand_genes
rand_genes = c("RMRPP1","PPIAP13","NDST2","RP11-574K11.8","RPL39P25")
rand_match = match.df[(match.df$gene_name %in% rand_genes),]
dim(rand_match)
rand_match
match_imp_results = ens.df[(ens.df$gene_name %in% rand_genes),]
dim(match_imp_results)
match_imp_results
which(rand_match != match_imp_results, arr.ind=TRUE)
conn <- odbcConnect("Impala DSN")
vcf = sqlFetch(conn, "p7dev.illumina_test")
head(vcf)
intergenic_csv = read.csv("./ensembl/intergenic_test.csv", sep="\t")
head(intergenic_csv)
intergenic_csv = read.csv("./ensembl/intergenic_test.csv", header=TRUE)
head(intergenic_csv)
intergenic_csv = intergenic_csv[,c(1:8)]
head(intergenic_csv)
rand_intergenic = sample(unique(intergenic_csv), 5)
rand_intergenic
head(intergenic_csv)
rand_intergenic = sample(unique(c(intergenic_csv$chromosome, intergenic_csv$position)), 5)
rand_intergenic
rand_intergenic = sample(unique(c(intergenic$sample_id)), 5)
rand_intergenic = sample(unique(c(intergenic_csv$sample_id)), 5)
rand_intergenic
rand_intergenic = intergenic_csv[sample(unique(c(intergenic_csv$sample_id)), 5),]
rand_intergenic
ens_results = read.csv("./ensembl/query_result_ensembl.csv")
ens_results = read.csv("../testing/ensembl/")
ens_results = read.csv("./ensembl/ensembl_query_result.csv")
setwd("~/impala_scripts/queries")
ens_results = read.csv("./ensembl/ensembl_query_result.csv")
ens_results = read.csv("./testing/ensembl/ensembl_query_result.csv", header=TRUE)
head(ens_results)
ens_results = read.csv("~/impala_scripts/queries/testing/ensembl/ensembl_query_result.csv", header=TRUE)
head(ens_results)
intergenic_csv = read.csv("~/impala_scripts/queries/testing/ensembl/intergenic_test.csv", header=TRUE)
head(intergenic_csv)
setwd("~/impala_scripts/queries/testing")
ucsc_results = read.csv("./ucsc//ucsc_query_result.csv", header=TRUE)
head(ucsc_results)
dim(ucsc_results)
suppressMessages(library(RODBC))
conn <- odbcConnect("Impala DSN")
vcf = sqlFetch(conn, "p7dev.illumina_test")
ucsc = sqlFetch(conn, "public_hg19.ucsc")
head(ucsc)
dim(ucsc)
head(vcf)
dim(vcf)
suppressMessages(library(GenomicRanges))
suppressMessages(library(IRanges))
##subset for only vcf rows that passed filtering
vcf_pass = vcf[which(vcf$filter == "PASS"),]
#create GRanges objects for comparison
vars = with(vcf_pass, GRanges(seqnames=vcf_pass$chromosome,
ranges=IRanges(vcf_pass$pos, width=1,
names=paste(vcf_pass$sample_id, ":",vcf_pass$ref, ">", vcf_pass$alt, sep="")),rsID=vcf_pass$id, filter=vcf_pass$filter, qual=vcf_pass$qual, sample_id=vcf_pass$sample_id))
genes = with(ucsc, GRanges(seqnames=ucsc$chrom,
ranges=IRanges(ucsc$txstart, ucsc$txend,names=ucsc$name),
proteinid=ucsc$proteinid, alignid=ucsc$alignid))
match = suppressWarnings(findOverlaps(vars, genes))
match
head(vars)
head(genes)
gsub("chr", "", ucsc$chrom)
genes = with(ucsc, GRanges(seqnames=as.character(gsub("chr", "", ucsc$chrom)),
ranges=IRanges(ucsc$txstart, ucsc$txend,names=ucsc$name),
proteinid=ucsc$proteinid, alignid=ucsc$alignid))
head(genes)
match = suppressWarnings(findOverlaps(vars, genes))
match
head(mcols(genes))
head(genes)
rownames(genes)
class(genes)
names(genes)
gene_name = as.character(names(genes))[subjectHits(match)]
head(gene_name)
genes = with(ucsc, GRanges(seqnames=as.character(gsub("chr", "", ucsc$chrom)),
ranges=IRanges(ucsc$txstart, ucsc$txend,names=ucsc$name),
proteinid=ucsc$proteinid))
##find variants that fall in gene regions
match = suppressWarnings(findOverlaps(vars, genes))
##turn results into a data frame
match.df = data.frame(sample_id = as.character(mcols(vars)$sample_id)[queryHits(match)],
chrom = seqnames(vars)[queryHits(match)],
pos = as.data.frame(ranges(vars))$start[queryHits(match)],
variant = as.character(lapply(strsplit(as.character(names(vars)[queryHits(match)]), ":"), function(x) x[2])),
rsId = as.character(mcols(vars)$rsID)[queryHits(match)],
gene_name = as.character(names(genes))[subjectHits(match)],
protein_id = mcols(genes)$proteinid[subjectHits(match)],
stringsAsFactors=F)
#450 rows, same as impala query
dim(match.df)
head(match.df)
head(ucsc_results)
ucsc_results$variant = paste(ucsc_results$vcf_ref, ">", ucsc_results$vcf_alt, sep="")
head(ucsc_results)
head(match.df)
dim(ucsc.df)
dim(ucsc_results)
head(ucsc_results)
head(match.df)
ucsc.df = ucsc_results[c(1,2,3,17,6,10,11,13,14,15,9)]
colnames(ucsc.df) = colnames(match.df)
ucsc_results = read.csv("./ucsc/ucsc_query_result.csv", header=TRUE)
head(ucsc_results)
dim(ucsc_results)
ucsc_results$variant = paste(ucsc_results$vcf_ref, ">", ucsc_results$vcf_alt, sep="")
head(ucsc_results)[14]
ucsc.df = ucsc_results[c(1,2,3,15,14,6,7,)]
colnames(match.df)
colnames(ucsc.df)
colnames(ucsc_results)
ucsc.df = ucsc_results[c(1,2,3,16,6,7,14)]
head(ucsc.df)
colnames(ucsc.df) = colnames(match.df)
head(ucsc.df)
head(match.df)
ucsc.df = ucsc.df[with(ucsc.df, order(sample_id, chrom, pos, variant, gene_name, gene_id, trans_name, trans_id, exon_id, feature)),]
ucsc.df = ucsc.df[with(ucsc.df, order(sample_id, chrom, pos, variant, gene_name)),]
match.df = match.df[with(match.df, order(sample_id, chrom, pos, variant, gene_name)),]
i = sapply(ucsc.df, is.factor)
ucsc.df[i] = lapply(ucsc.df[i], as.character)
j = sapply(match.df, is.factor)
match.df[j] = lapply(match.df[j], as.character)
head(match.df)
head(ucsc.df)
rownames(match.df)= NULL
rownames(ucsc.df) = NULL
head(ucsc.df$rsId, 50)
head(ucsc.df$rsId, 500)
which(match.df != ucsc.df, arr.ind=TRUE)
head(ucsc.df)
dim(ucsc.df)
unique(ucsc.df$protein_id)
length(unique(ucsc.df$protein_id))
str(ucsc_results$proteinid)
str(ucsc_results$ucsc_proteinid)
rand_genes = sample(ucscque(match.df$gene_name), 5)
rand_genes = sample(unique(match.df$gene_name), 5)
rand_genes
rand_genes = c(uc031qze.1","uc004dhp.3","uc003wvt.4","uc021ujc.2","uc003llx.3")
rand_genes = c("uc031qze.1","uc004dhp.3","uc003wvt.4","uc021ujc.2","uc003llx.3")
rand_genes
rand_match = match.df[(match.df$gene_name %in% rand_genes),]
dim(rand_match)
rand_match
head(rand_match)
head(match.df)
head(ucsc.df$gene_name)
match_imp_results = ucsc.df[(ucsc.df$gene_name %in% rand_genes),]
dim(match_imp_results)
dim(rand_match)
which(rand_match != match_imp_results, arr.ind=TRUE)
ucsc_results = read.csv("~//impala_scripts/ucsc/ucsc_query_result.csv", header=TRUE)
ucsc_results = read.csv("~//impala_scripts/queries/testing/ucsc/ucsc_query_result.csv", header=TRUE)
intergenics = read.csv("~/impala_scripts/queries/testing/ucsc/intergenic_query_result.csv", header=TRUE)
head(intergenics)
intergenics$id = paste(intergenics$sample_id, intergenics$chromosome, intergenics$position, intergenics$id, sep="_")
head(ucsc_results)
head(match.df)
match.df$id = paste(match.df$sample_id, match.df$chrom, match.df$pos, match.df$rsId)
head(match.df$id)
match.df$id = paste(match.df$sample_id, match.df$chrom, match.df$pos, match.df$rsId, sep="_")
head(match.df$id)
head(intergenics$id)
head(vars)
as.character(mcols(vars)$sample_id)[queryHits(match)]
head(as.character(mcols(vars)$sample_id)[queryHits(match)])
head(as.character(mcols(vars)$sample_id)[queryHits(match)], 50)
match.df = data.frame(sample_id = as.character(mcols(vars)$sample_id)[queryHits(match)],
chrom = seqnames(vars)[queryHits(match)],
pos = as.data.frame(ranges(vars))$start[queryHits(match)],
variant = as.character(lapply(strsplit(as.character(names(vars)[queryHits(match)]), ":"), function(x) x[2])),
rsId = as.character(mcols(vars)$rsID)[queryHits(match)],
gene_name = as.character(names(genes))[subjectHits(match)],
protein_id = mcols(genes)$proteinid[subjectHits(match)],
stringsAsFactors=F)
head(match.df)
match.df = match.df[with(match.df, order(sample_id, chrom, pos, variant, gene_name)),]
head(as.character(mcols(vars)$sample_id)[queryHits(match)], 50)
match.df = match.df[with(match.df, order(sample_id, chrom, pos, variant, gene_name)),]
head(match.df)
grep("101-371-M", mcols(vars)$sample_id)
head(match.df$id)
head(intergenics$id)
match.df$id = paste(match.df$sample_id, match.df$chrom, match.df$pos, match.df$rsId, sep="_")
j = sapply(match.df, is.factor)
match.df[j] = lapply(match.df[j], as.character)
rownames(match.df)= NULL
match.df$id %in% intergenics$id
intergenics[(match.df$id %in% intergenics$id,]
intergenics[(match.df$id %in% intergenics$id,)]
intergenics[which(match.df$id %in% intergenics$id,)]
intergenics[which(match.df$id %in% intergenics$id),]
match.df[which(intergenics$id %in% match.df$id),]
setwd("~/impala_scripts")
vcf_in = "./LP6008020-DNA_D03.genome.vcf.gz"
info_out = "~/impala_scripts/"
get_info = function(vcf){
#examine vcf header to grab info fields
hdr =  scanVcfHeader(vcf)
#build data frame from info fields
info = data.frame(field = rownames(info(hdr)), type="STRING", comment="COMMENT", description = paste("'", info(hdr)$Description, "'", sep=""))
##write info to a file for db_def
write.table(info, paste(info_out, paste(lapply(strsplit(basename(vcf), "[.]"), function(x) x[1]), "info", sep="_"), ".txt", sep=""),
quote=FALSE, row.names=FALSE, col.names=FALSE)
}
get_info(vcf_in)
###################
library(VariantAnnotation)
get_info = function(vcf){
#examine vcf header to grab info fields
hdr =  scanVcfHeader(vcf)
#build data frame from info fields
info = data.frame(field = rownames(info(hdr)), type="STRING", comment="COMMENT", description = paste("'", info(hdr)$Description, "'", sep=""))
##write info to a file for db_def
write.table(info, paste(info_out, paste(lapply(strsplit(basename(vcf), "[.]"), function(x) x[1]), "info", sep="_"), ".txt", sep=""),
quote=FALSE, row.names=FALSE, col.names=FALSE)
}
get_info(vcf_in)
